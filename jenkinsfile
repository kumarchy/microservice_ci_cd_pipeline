pipeline {
    agent any

    environment {
        // Correct credential binding syntax
        MONGO_URI = credentials('MONGO_URI')
        DATABASE_URL_1 = credentials('DATABASE_URL_1')
        DATABASE_URL_3 = credentials('DATABASE_URL_3')
        JWT_SECRET = credentials('JWT_SECRET')   
        PORT_1 = credentials('PORT_1')
        PORT_2 = credentials('PORT_2')
        PORT_3 = credentials('PORT_3')
        GATEWAY_PORT = credentials('GATEWAY_PORT')
        AUTH_SERVICE_URL = credentials('AUTH_SERVICE_URL')
        PRODUCT_SERVICE_URL = credentials('PRODUCT_SERVICE_URL')
        ORDER_SERVICE_URL = credentials('ORDER_SERVICE_URL')
    }

    stages {
        stage('Clone Code'){
            steps {
                git branch:'main', url:'https://github.com/kumarchy/microservice_ci_cd_pipeline'
            }
        }
        
        stage('Client Tests'){
            steps {
                dir('client'){
                    sh 'npm install'
                   // sh 'npm test'
                }
            }
        }
        
        stage('Server Tests'){
            steps {
                dir('auth-service'){
                    sh 'npm install'
                    // Use proper environment variable export syntax
                    sh "export PORT=${PORT_1}"
                    sh "export JWT_SECRET=${JWT_SECRET}"
                    sh "export DATABASE_URL=${DATABASE_URL_1}"
                }
                
                dir('product-service'){
                    sh 'npm install'
                    sh "export PORT=${PORT_2}"
                    sh "export MONGO_URI=${MONGO_URI}"
                }

                dir('order-service'){
                    sh 'npm install'
                    sh "export PORT=${PORT_3}"
                    sh "export DATABASE_URL=${DATABASE_URL_3}"
                }

                dir('gateway'){
                    sh 'npm install'
                    sh "export PORT=${GATEWAY_PORT}"
                    sh "export AUTH_SERVICE_URL=${AUTH_SERVICE_URL}"
                    sh "export PRODUCT_SERVICE_URL=${PRODUCT_SERVICE_URL}"
                    sh "export ORDER_SERVICE_URL=${ORDER_SERVICE_URL}"
                }
            }
        }

        stage('Build & Run Containers'){
            steps {
                sh 'docker-compose up -d --build'
            }
        }
    }
}